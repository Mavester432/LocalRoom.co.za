<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Landlord Dashboard ‚Äì LocalRoom</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .dashboard-container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    .listing {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .listing img {
      max-width: 120px;
      max-height: 100px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }
    .listing-images {
      display: flex;
      margin-top: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    button, .home-btn, .dashboard-btn {
      background: #e63946;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      text-decoration: none;
      display: inline-block;
      font-size: 1rem;
      text-align: center;
    }
    button:hover, .home-btn:hover, .dashboard-btn:hover {
      background: #d62828;
    }
    .edit-btn {
      background-color: #457b9d;
    }
    .edit-btn:hover {
      background-color: #1d3557;
    }
    .delete-btn {
      background-color: #999;
    }
    .delete-btn:hover {
      background-color: #666;
    }
  </style>
</head>
<body>

<div class="dashboard-container">
  <div class="top-bar">
    <h2 id="welcomeMessage">Welcome Landlord</h2>
    <div>
      <a href="index.html" class="home-btn">üè† Home</a>
      <a href="list-room.html"><button>‚ûï List New Room</button></a>
      <!-- Inbox button removed -->
      <button id="logout">Logout</button>
    </div>
  </div>

  <div id="listings"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase-config.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const listingsContainer = document.getElementById("listings");
  const logoutBtn = document.getElementById("logout");
  const welcomeMessage = document.getElementById("welcomeMessage");

  // Named beforeUnload handler so we can remove it if needed
  function beforeUnloadHandler(e) {
    e.preventDefault();
    e.returnValue = '';
  }

  // Add beforeunload listener
  window.addEventListener("beforeunload", beforeUnloadHandler);

  // Logout handler
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // Optional: For SPA style back button interception:
  window.history.pushState(null, "", window.location.href);
  window.addEventListener('popstate', function (event) {
    const confirmLeave = confirm("You are about to logout. Do you want to proceed?");
    if (confirmLeave) {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    } else {
      // Prevent back navigation by pushing the state again
      window.history.pushState(null, "", window.location.href);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("You must be logged in to view the dashboard.");
      window.location.href = "login.html";
      return;
    }

    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "landlord") {
      alert("Access denied. Only landlords can access the dashboard.");
      window.location.href = "listings.html";
      return;
    }

    // Set personalized welcome message here:
    const landlordName = userDoc.data().name || "Landlord";
    welcomeMessage.textContent = `Welcome ${landlordName}`;

    const q = query(collection(db, "listings"), where("landlordId", "==", user.uid));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      listingsContainer.innerHTML = "<p>You haven't listed any rooms yet.</p>";
      return;
    }

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const docId = docSnap.id;
      const div = document.createElement("div");
      div.classList.add("listing");

      div.innerHTML = `
        <h3>${data.title}</h3>
        <p><strong>Location:</strong> ${data.location}</p>
        <p><strong>Price:</strong> ZAR ${data.price}</p>
        <div class="listing-images">
          ${data.images.map(url => `<img src="${url}" alt="Room image">`).join('')}
        </div>
        <div style="margin-top: 10px;">
          <button class="edit-btn" onclick="window.location.href='edit-room.html?id=${docId}'">‚úèÔ∏è Edit</button>
          <button class="delete-btn" data-id="${docId}">üóë Delete</button>
        </div>
      `;

      listingsContainer.appendChild(div);
    });

    // Attach delete button event listeners after render
    setTimeout(() => {
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          const confirmDelete = confirm("Are you sure you want to delete this listing?");
          if (!confirmDelete) return;

          try {
            await deleteDoc(doc(db, "listings", id));
            alert("Listing deleted!");
            location.reload();
          } catch (err) {
            console.error("Delete failed:", err);
            alert("Something went wrong while deleting.");
          }
        });
      });
    }, 200);
  });
</script>

</body>
</html>
