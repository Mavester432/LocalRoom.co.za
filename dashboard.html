<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Landlord Dashboard ‚Äì LocalRoom</title>
<link rel="stylesheet" href="css/style.css" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background:#f4f6f8; margin:0; padding:0; }
  .dashboard-container { padding: 20px; max-width: 900px; margin: auto; }
  .listing { border:1px solid #ddd; padding:15px; margin-bottom:20px; border-radius:8px; position:relative; background:white; }
  .listing img { max-width:120px; max-height:100px; object-fit:cover; margin-right:10px; border-radius:4px; }
  .listing-images { display:flex; margin-top:10px; flex-wrap:wrap; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
  button, .home-btn { background:#e63946; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; text-decoration:none; font-size:1rem; }
  button:hover, .home-btn:hover { background:#d62828; }
  .edit-btn { background-color: #457b9d; margin-right:5px; }
  .edit-btn:hover { background-color: #1d3557; }
  .delete-btn { background-color: #999; }
  .delete-btn:hover { background-color: #666; }
  .contact-options-container { position: relative; display:inline-block; }
  .contact-options { display: none; position:absolute; background:white; border:1px solid #ccc; padding:10px; border-radius:5px; top:35px; left:0; z-index:10; width:180px; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
  .contact-options a { display:block; margin-bottom:8px; font-weight:bold; text-decoration:none; }
  .contact-options a.whatsapp { color:#25D366; }
  .contact-options a.email { color:#1e90ff; }
  .contact-options a:last-child { margin-bottom:0; }

  /* Toast Notifications */
  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display:flex; flex-direction: column; gap:10px; }
  .toast { background:#333; color:white; padding:10px 15px; border-radius:5px; opacity:0.9; animation:fadein 0.5s, fadeout 0.5s 2.5s; }
  @keyframes fadein { from {opacity:0; transform:translateY(-10px);} to {opacity:0.9; transform:translateY(0);} }
  @keyframes fadeout { from {opacity:0.9;} to {opacity:0;} }
</style>
</head>
<body>

<div class="dashboard-container">
  <div class="top-bar">
    <h2 id="welcomeMessage">Welcome Landlord</h2>
    <div>
      <a href="index.html" class="home-btn">üè† Home</a>
      <button id="listRoomBtn">‚ûï List New Room</button>
      <button id="logout">Logout</button>
    </div>
  </div>

  <div id="listings"></div>
</div>

<div id="toast-container" class="toast-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MSG_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const listingsContainer = document.getElementById("listings");
const logoutBtn = document.getElementById("logout");
const listRoomBtn = document.getElementById("listRoomBtn");
const welcomeMessage = document.getElementById("welcomeMessage");
const toastContainer = document.getElementById("toast-container");

// ===== Toast Function =====
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ===== Logout =====
logoutBtn.addEventListener("click", async () => {
  if (confirm("Are you sure you want to logout?")) {
    await signOut(auth);
    window.location.href = "login.html";
  }
});

// ===== List New Room Button =====
listRoomBtn.addEventListener("click", () => window.location.href = "list-room.html");

// ===== Back Button / Navigation Warning =====
window.history.pushState(null, "", window.location.href);
window.addEventListener("popstate", () => {
  if (confirm("You are about to logout. Proceed?")) {
    signOut(auth).then(() => window.location.href = "index.html");
  } else {
    window.history.pushState(null, "", window.location.href);
  }
});

// ===== Fetch Landlord Listings =====
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    showToast("You must log in.");
    window.location.href = "login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().role !== "landlord") {
    showToast("Access denied.");
    window.location.href = "listings.html";
    return;
  }

  const landlordName = userDoc.data().name || "Landlord";
  welcomeMessage.textContent = `Welcome ${landlordName}`;

  const q = query(collection(db, "listings"), where("landlordId", "==", user.uid));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    listingsContainer.innerHTML = "<p>You haven't listed any rooms yet.</p>";
    return;
  }

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const docId = docSnap.id;
    const whatsappLink = data.whatsappNumber ? `https://wa.me/${data.whatsappNumber}` : "#";
    const emailLink = data.email ? `mailto:${data.email}` : "#";

    const div = document.createElement("div");
    div.className = "listing";
    div.innerHTML = `
      <h3>${data.title}</h3>
      <p><strong>Location:</strong> ${data.location}</p>
      <p><strong>Price:</strong> ZAR ${data.price}</p>
      <div class="listing-images">
        ${(data.images || []).map(url => `<img src="${url}" alt="Room image">`).join('')}
      </div>
      <div style="margin-top:10px;">
        <button class="edit-btn" data-id="${docId}">‚úèÔ∏è Edit</button>
        <button class="delete-btn" data-id="${docId}">üóë Delete</button>
      </div>
      <div style="margin-top:10px;">
        <div class="contact-options-container">
          <button class="contact-btn">Contact Landlord</button>
          <div class="contact-options">
            <a href="${whatsappLink}" target="_blank" rel="noopener" class="whatsapp">üì± WhatsApp</a>
            <a href="${emailLink}" class="email">üìß Email</a>
          </div>
        </div>
      </div>
    `;
    listingsContainer.appendChild(div);

    // Edit Button
    div.querySelector(".edit-btn").addEventListener("click", () => {
      window.location.href = `edit-room.html?id=${docId}`;
    });

    // Delete Button
    div.querySelector(".delete-btn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this listing?")) return;
      try {
        await deleteDoc(doc(db, "listings", docId));
        showToast("Listing deleted!");
        div.remove();
      } catch (err) {
        console.error(err);
        showToast("Failed to delete listing.");
      }
    });

    // Contact Button Toggle
    const contactBtn = div.querySelector(".contact-btn");
    const contactOptions = div.querySelector(".contact-options");
    contactBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      document.querySelectorAll(".contact-options").forEach(o => { if(o!==contactOptions) o.style.display="none"; });
      contactOptions.style.display = contactOptions.style.display === "block" ? "none" : "block";
    });
  });

  // Close all contact dropdowns when clicking outside
  document.addEventListener("click", () => {
    document.querySelectorAll(".contact-options").forEach(o => o.style.display="none");
  });
});
</script>

</body>
</html>
