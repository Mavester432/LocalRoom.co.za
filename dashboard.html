<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Landlord Dashboard ‚Äì LocalRoom</title>
<style>
  body {
    font-family:'Segoe UI',sans-serif;
    background:#f4f6f8;
    margin:0;
    padding:0;
    display:flex;
    min-height:100vh;
    overflow-x:hidden;
  }

  /* ===== Sidebar ===== */
  .sidebar {
    width:260px;
    background:#1d3557;
    color:white;
    display:flex;
    flex-direction:column;
    padding:20px 15px;
    position:fixed;
    top:0;
    left:0;
    height:100%;
    transition:left 0.3s ease;
    z-index:1000;
  }
  .sidebar.closed {
    left:-260px; /* hidden on mobile by default */
  }

  .profile-section {
    text-align:center;
    margin-bottom:25px;
  }
  .profile-section img {
    width:80px;
    height:80px;
    border-radius:50%;
    object-fit:cover;
    border:3px solid #457b9d;
  }
  .profile-section h3 {
    margin:10px 0 5px;
  }
  .profile-section p {
    font-size:13px;
    opacity:0.8;
  }

  .sidebar button {
    width:100%;
    text-align:left;
    padding:10px 12px;
    margin:5px 0;
    border:none;
    border-radius:6px;
    background:#457b9d;
    color:white;
    font-weight:600;
    cursor:pointer;
  }
  .sidebar button:hover {
    background:#27496d;
  }

  .stats {
    background:rgba(255,255,255,0.1);
    padding:10px;
    border-radius:8px;
    margin-top:auto;
  }
  .stats p { margin:6px 0; font-size:14px; }

  /* ===== Main Content ===== */
  .main-content {
    flex:1;
    padding:20px;
    margin-left:260px; /* space for sidebar on desktop */
    overflow-y:auto;
    transition: margin-left 0.3s ease;
  }

  .top-bar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    flex-wrap:wrap;
    gap:10px;
  }
  .top-bar h2 { color:#1d3557; }
  .top-bar button {
    background:#e63946;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:4px;
    cursor:pointer;
    font-weight:600;
  }
  .top-bar button:hover { background:#d62828; }

  .listing {
    border:1px solid #ddd;
    padding:15px;
    margin-bottom:20px;
    border-radius:8px;
    background:white;
  }
  .listing img {
    max-width:120px;
    max-height:100px;
    object-fit:cover;
    margin-right:10px;
    border-radius:4px;
  }
  .listing-images { display:flex; margin-top:10px; flex-wrap:wrap; }
  .edit-btn { background:#457b9d; margin-right:5px; }
  .edit-btn:hover { background:#1d3557; }
  .delete-btn { background:#999; }
  .delete-btn:hover { background:#666; }

  /* Toast */
  .toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
  .toast { background:#333; color:white; padding:10px 15px; border-radius:5px; opacity:0.9; }

  /* Profile Modal */
  #profileModal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    z-index:1001;
    justify-content:center;
    align-items:center;
  }
  #profileModal .modal-content {
    background:white;
    padding:20px;
    border-radius:8px;
    width:90%;
    max-width:400px;
    position:relative;
  }
  #profileModal h3 { margin-top:0; }
  #profileModal label { display:block; margin-top:10px; font-weight:600; }
  #profileModal input {
    width:100%;
    padding:8px;
    border-radius:4px;
    border:1px solid #ccc;
    margin-top:5px;
  }
  #profileModal img {
    max-width:80px;
    max-height:80px;
    border-radius:50%;
    display:block;
    margin-top:10px;
  }
  #profileModal button {
    margin-top:15px;
    padding:10px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-weight:600;
    background:#457b9d;
    color:white;
  }
  #profileModal button:hover { background:#1d3557; }
  #closeProfile {
    position:absolute;
    top:10px;
    right:10px;
    background:#e63946;
  }
  #closeProfile:hover { background:#d62828; }

  /* Hamburger Button */
  #hamburgerBtn {
    display:none;
    position:fixed;
    top:15px;
    left:15px;
    z-index:1002;
    background:#1d3557;
    color:white;
    border:none;
    padding:10px 12px;
    border-radius:6px;
    cursor:pointer;
  }

  /* ===== Responsive ===== */
  @media (max-width:800px) {
    .sidebar { left:-260px; }
    .sidebar.open { left:0; } /* slides over content */
    .main-content { margin-left:0; padding:15px; }
    #hamburgerBtn { display:block; }
  }
</style>
</head>
<body>

<!-- Hamburger button -->
<button id="hamburgerBtn">‚ò∞ Menu</button>

<!-- ===== Sidebar ===== -->
<div class="sidebar closed">
  <div class="profile-section">
    <img id="sidebarProfilePic" src="https://via.placeholder.com/80" alt="Profile Picture">
    <h3 id="sidebarName">Landlord</h3>
    <p id="sidebarEmail">user@email.com</p>
  </div>

  <button id="listRoomBtn">‚ûï List New Room</button>
  <button id="viewListingsBtn">üìÑ My Listings</button>
  <button id="profileBtn">üë§ Edit Profile</button>
  <button id="subscriptionBtn">üí≥ Subscription</button>
  <button id="logoutBtn">üö™ Logout</button>

  <div class="stats">
    <p><strong>Trial Days Left:</strong> <span id="trialDays">--</span></p>
    <p><strong>Active Listings:</strong> <span id="activeListings">--</span></p>
    <p><strong>Total Views:</strong> <span id="totalViews">--</span></p>
  </div>
</div>

<!-- ===== Main Content ===== -->
<div class="main-content">
  <div class="top-bar">
    <h2 id="welcomeMessage">Welcome Landlord</h2>
  </div>
  <div id="listings"></div>
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container"></div>

<!-- Profile Modal -->
<div id="profileModal">
  <div class="modal-content">
    <button id="closeProfile">‚úñ</button>
    <h3>Profile</h3>
    <label for="profileName">Name:</label>
    <input type="text" id="profileName">

    <label for="profileEmail">Email:</label>
    <input type="email" id="profileEmail" disabled>

    <label for="profilePhone">Phone:</label>
    <input type="text" id="profilePhone">

    <label>Profile Picture:</label>
    <input type="file" id="profilePic">
    <img id="profilePicPreview" src="https://via.placeholder.com/80" alt="Profile Picture">

    <button id="saveProfileBtn">Save Profile</button>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { collection, query, where, getDocs, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const listingsContainer = document.getElementById("listings");
const logoutBtn = document.getElementById("logoutBtn");
const listRoomBtn = document.getElementById("listRoomBtn");
const profileBtn = document.getElementById("profileBtn");
const welcomeMessage = document.getElementById("welcomeMessage");
const toastContainer = document.getElementById("toast-container");

const sidebarName = document.getElementById("sidebarName");
const sidebarEmail = document.getElementById("sidebarEmail");
const sidebarProfilePic = document.getElementById("sidebarProfilePic");
const trialDays = document.getElementById("trialDays");
const activeListings = document.getElementById("activeListings");
const totalViews = document.getElementById("totalViews");

const profileModal = document.getElementById("profileModal");
const closeProfile = document.getElementById("closeProfile");
const profileName = document.getElementById("profileName");
const profileEmail = document.getElementById("profileEmail");
const profilePhone = document.getElementById("profilePhone");
const profilePic = document.getElementById("profilePic");
const profilePicPreview = document.getElementById("profilePicPreview");

const hamburgerBtn = document.getElementById("hamburgerBtn");
const sidebar = document.querySelector(".sidebar");

let currentUser = null;

const showToast = (msg) => {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = msg;
  toastContainer.appendChild(toast);
  setTimeout(()=>toast.remove(),3000);
};

// ===== Hamburger toggle =====
hamburgerBtn.addEventListener("click", ()=>{
  sidebar.classList.toggle("open");
});

// ===== Click outside to close sidebar on mobile =====
document.addEventListener("click",(e)=>{
  if(window.innerWidth <= 800){
    if(!sidebar.contains(e.target) && !hamburgerBtn.contains(e.target)){
      sidebar.classList.remove("open");
    }
  }
});

// ===== Auth & Fetch Listings =====
onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }
  currentUser=user;
  welcomeMessage.textContent=`Welcome ${user.displayName||"Landlord"}`;

  const userDocRef = doc(db,"users",user.uid);
  const userDocSnap = await getDoc(userDocRef);
  if(userDocSnap.exists()){
    const data = userDocSnap.data();
    sidebarName.textContent = data.name || "Landlord";
    sidebarEmail.textContent = data.email || user.email;
    if(data.photoURL){ sidebarProfilePic.src = data.photoURL; profilePicPreview.src=data.photoURL; }
    profileName.value = data.name || "";
    profileEmail.value = data.email || user.email || "";
    profilePhone.value = data.phone || "";
  }

  const q = query(collection(db,"listings"),where("landlordId","==",user.uid));
  const snapshot = await getDocs(q);
  activeListings.textContent = snapshot.size || 0;
  let total = 0;

  listingsContainer.innerHTML="";
  if(snapshot.empty){
    listingsContainer.innerHTML="<p>You haven't listed any rooms yet.</p>";
  } else {
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      total += data.viewsCount || 0;
      const div = document.createElement("div");
      div.className="listing";
      div.innerHTML=`
        <h3>${data.title}</h3>
        <p><strong>Location:</strong> ${data.city||data.location}</p>
        <p><strong>Price:</strong> R${data.price}</p>
        <div class="listing-images">${(data.images||[]).map(url=>`<img src="${url}" />`).join('')}</div>
        <button class="edit-btn" data-id="${docSnap.id}">‚úèÔ∏è Edit</button>
        <button class="delete-btn" data-id="${docSnap.id}">üóë Delete</button>
      `;
      listingsContainer.appendChild(div);

      div.querySelector(".edit-btn").addEventListener("click",()=>window.location.href=`edit-room.html?id=${docSnap.id}`);
      div.querySelector(".delete-btn").addEventListener("click",async()=>{
        if(confirm("Delete this room?")){
          await deleteDoc(doc(db,"listings",docSnap.id));
          showToast("Listing deleted!");
          div.remove();
        }
      });
    });
  }
  totalViews.textContent = total;
  trialDays.textContent = "15"; // mock trial days
});

// ===== Buttons =====
logoutBtn.addEventListener("click",async()=>{ if(confirm("Logout?")){ await signOut(auth); window.location.href="login.html"; } });
listRoomBtn.addEventListener("click",()=>window.location.href="list-room.html");
profileBtn.addEventListener("click",()=>profileModal.style.display="flex");
closeProfile.addEventListener("click",()=>profileModal.style.display="none");

// ===== Profile Picture Preview =====
profilePic.addEventListener("change",()=>{ const file = profilePic.files[0]; if(file) profilePicPreview.src=URL.createObjectURL(file); });

// ===== Save Profile =====
saveProfileBtn.addEventListener("click",async()=>{
  if(!currentUser) return;
  const name = profileName.value.trim();
  const phone = profilePhone.value.trim();
  let photoURL = profilePicPreview.src;

  try{
    if(profilePic.files[0]){
      const formData = new FormData();
      formData.append("file", profilePic.files[0]);
      formData.append("upload_preset","unsigned_preset");
      const res = await fetch("https://api.cloudinary.com/v1_1/dixamcwb1/image/upload",{method:"POST",body:formData});
      const data = await res.json();
      if(data.secure_url) photoURL = data.secure_url;
    }
    await setDoc(doc(db,"users",currentUser.uid),{name, phone, photoURL},{merge:true});
    await updateProfile(currentUser,{displayName:name, photoURL});
    sidebarName.textContent = name || "Landlord";
    sidebarProfilePic.src = photoURL;
    showToast("Profile updated!");
    profileModal.style.display="none";
  }catch(err){ console.error(err); showToast("Failed to update profile"); }
});
</script>
</body>
</html>
