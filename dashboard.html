<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Landlord Dashboard ‚Äì LocalRoom</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background:#f4f6f8; margin:0; padding:0; }
  .dashboard-container { padding:20px; max-width:900px; margin:auto; }
  .listing { border:1px solid #ddd; padding:15px; margin-bottom:20px; border-radius:8px; background:white; }
  .listing img { max-width:120px; max-height:100px; object-fit:cover; margin-right:10px; border-radius:4px; }
  .listing-images { display:flex; margin-top:10px; flex-wrap:wrap; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
  button { background:#e63946; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; }
  button:hover { background:#d62828; }
  .edit-btn { background:#457b9d; margin-right:5px; }
  .edit-btn:hover { background:#1d3557; }
  .delete-btn { background:#999; }
  .delete-btn:hover { background:#666; }
  .toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
  .toast { background:#333; color:white; padding:10px 15px; border-radius:5px; opacity:0.9; }
</style>
</head>
<body>

<div class="dashboard-container">
  <div class="top-bar">
    <h2 id="welcomeMessage">Welcome Landlord</h2>
    <div>
      <button id="listRoomBtn">‚ûï List New Room</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
  <div id="listings"></div>
</div>

<div id="toast-container" class="toast-container"></div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const listingsContainer = document.getElementById("listings");
const logoutBtn = document.getElementById("logoutBtn");
const listRoomBtn = document.getElementById("listRoomBtn");
const welcomeMessage = document.getElementById("welcomeMessage");
const toastContainer = document.getElementById("toast-container");

const showToast = (msg) => {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = msg;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
};

logoutBtn.addEventListener("click", async () => {
  if (confirm("Logout?")) {
    await signOut(auth);
    window.location.href = "login.html";
  }
});

listRoomBtn.addEventListener("click", ()=> window.location.href="list-room.html");

onAuthStateChanged(auth, async (user) => {
  if(!user){ window.location.href="login.html"; return; }
  try {
    const userDocRef = doc(db,"users",user.uid);
    const userDoc = await getDocs(collection(db,"users")); // optional check
    // Show welcome
    welcomeMessage.textContent = `Welcome ${user.displayName || "Landlord"}`;

    // Fetch listings for this landlord
    const q = query(collection(db,"listings"), where("landlordId","==",user.uid));
    const snapshot = await getDocs(q);

    if(snapshot.empty){
      listingsContainer.innerHTML="<p>You haven't listed any rooms yet.</p>";
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className="listing";
      div.innerHTML=`
        <h3>${data.title}</h3>
        <p><strong>Location:</strong> ${data.location}</p>
        <p><strong>Price:</strong> R${data.price}</p>
        <div class="listing-images">${(data.images||[]).map(url=>`<img src="${url}" />`).join('')}</div>
        <button class="edit-btn" data-id="${docSnap.id}">‚úèÔ∏è Edit</button>
        <button class="delete-btn" data-id="${docSnap.id}">üóë Delete</button>
      `;
      listingsContainer.appendChild(div);

      div.querySelector(".edit-btn").addEventListener("click", ()=> window.location.href=`edit-room.html?id=${docSnap.id}`);
      div.querySelector(".delete-btn").addEventListener("click", async ()=> {
        if(confirm("Delete this room?")){
          await deleteDoc(doc(db,"listings",docSnap.id));
          showToast("Listing deleted!");
          div.remove();
        }
      });
    });
  } catch(err){ console.error(err); showToast("Error loading listings"); }
});
</script>
</body>
</html>
