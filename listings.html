<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Browse Rooms â€“ LocalRoom</title>
<style>
  body {
    font-family: sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding-bottom: 80px; /* prevent overlap with sticky contact bar */
  }

  .listings-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 10px;
  }

  .room-card {
    background: #fff;
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s;
    cursor: pointer;
  }

  .room-card:hover {
    transform: translateY(-2px);
  }

  .room-card img {
    max-width: 100px;
    margin: 5px 5px 5px 0;
    border-radius: 5px;
  }

  input#filter {
    width: 80%;
    max-width: 400px;
    padding: 10px;
    margin: 20px auto;
    display: block;
    border: 1px solid #ccc;
    border-radius: 8px;
  }

  .contact-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .contact-buttons a {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    color: white;
    text-decoration: none;
    font-weight: bold;
    font-size: 14px;
  }

  .whatsapp-btn { background-color: #25D366; }
  .call-btn { background-color: #007bff; }

  /* Sticky contact bar for mobile */
  .sticky-contact {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #fff;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-around;
    padding: 10px;
    z-index: 100;
  }

  .sticky-contact a {
    flex: 1;
    margin: 0 5px;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    color: white;
    text-decoration: none;
    font-weight: bold;
  }

  .sticky-contact .whatsapp-btn { background-color: #25D366; }
  .sticky-contact .call-btn { background-color: #007bff; }

  @media (max-width: 768px) {
    .room-card img { max-width: 80px; }
    input#filter { width: 90%; }
  }
</style>
</head>
<body>

<input type="text" id="filter" placeholder="Search by location or title..." />
<div class="listings-container"></div>

<!-- Sticky contact bar for mobile -->
<div id="stickyBar" class="sticky-contact">
  <a id="stickyWhatsApp" href="#" target="_blank" class="whatsapp-btn">ðŸ’¬ WhatsApp</a>
  <a id="stickyCall" href="#" class="call-btn">ðŸ“ž Call</a>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const container = document.querySelector(".listings-container");
const filterInput = document.getElementById("filter");
const stickyBar = document.getElementById("stickyBar");
const stickyWhatsApp = document.getElementById("stickyWhatsApp");
const stickyCall = document.getElementById("stickyCall");

let allRooms = [];

// Function to display room cards
const displayRooms = (rooms) => {
  container.innerHTML = "";
  if (rooms.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#555;'>No rooms found.</p>";
    stickyBar.style.display = "none";
    return;
  }

  rooms.forEach(room => {
    const card = document.createElement("div");
    card.className = "room-card";
    const phone = room.phone ? room.phone.replace(/\s+/g, "") : "";

    card.innerHTML = `
      <h3>${room.title || "Untitled Room"}</h3>
      <p>${room.location || "Location not specified"} â€“ R${room.price || "N/A"}/month</p>
      <div>${(room.images || []).map(url => `<img src="${url}" alt="Room image">`).join('')}</div>
      ${
        phone
          ? `<div class="contact-buttons">
              <a href="https://wa.me/${phone.startsWith('+') ? phone.slice(1) : phone}" target="_blank" class="whatsapp-btn">ðŸ’¬ Chat on WhatsApp</a>
              <a href="tel:${phone}" class="call-btn">ðŸ“ž Call Now</a>
            </div>`
          : `<p style="color:#888;font-size:13px;margin-top:8px;">Contact details not available</p>`
      }
    `;

    if (phone) {
      card.addEventListener("click", () => {
        stickyWhatsApp.href = `https://wa.me/${phone.startsWith('+') ? phone.slice(1) : phone}`;
        stickyCall.href = `tel:${phone}`;
        stickyBar.style.display = "flex";
      });
    }

    container.appendChild(card);
  });
};

// Fetch rooms from Firestore
const fetchRooms = async () => {
  try {
    const q = query(collection(db, "listings"), orderBy("createdAt", "desc"));
    const snapshot = await getDocs(q);
    allRooms = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    displayRooms(allRooms);
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p style='text-align:center;color:red;'>Failed to load rooms.</p>";
  }
};

// Filter functionality
filterInput.addEventListener("input", () => {
  const val = filterInput.value.toLowerCase();
  displayRooms(
    allRooms.filter(
      r => (r.title || "").toLowerCase().includes(val) || (r.location || "").toLowerCase().includes(val)
    )
  );
});

// Initial load
fetchRooms();
</script>

</body>
</html>
