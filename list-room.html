<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>List a Room ‚Äì LocalRoom</title>
<style>
  body, html { font-family: 'Poppins', sans-serif; background:#f4f6f8; margin:0; padding:0; }

  .top-bar { display:flex; justify-content:space-between; max-width:900px; margin:20px auto; padding:0 10px; }
  .top-bar button { background:#e63946; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.3s; }
  .top-bar button:hover { background:#d62828; }

  .form-container { max-width:500px; margin:20px auto; background:white; padding:25px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); display:none; }
  .form-container h2 { text-align:center; margin-bottom:20px; color:#1d3557; }
  .form-container label { display:block; margin:10px 0 5px; font-weight:600; }
  .form-container input, .form-container textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; }
  .form-container button[type="submit"] { background:#1d3557; color:white; border:none; padding:12px; border-radius:25px; cursor:pointer; width:100%; font-weight:600; margin-top:10px; transition: background 0.3s ease; }
  .form-container button[type="submit"]:hover { background:#457b9d; }

  #preview-container { display:flex; flex-wrap:wrap; margin-top:10px; }
  #preview-container img { max-width:100px; max-height:100px; object-fit:cover; margin-right:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>

<div class="top-bar">
  <button id="homeBtn">üè† Home</button>
  <button id="logoutBtn">Logout</button>
</div>

<div class="form-container" id="page-content">
  <h2>List a Room</h2>
  <form id="list-room-form">
    <label for="title">Room Title:</label>
    <input type="text" id="title" placeholder="e.g. Cozy 1-Bedroom Apartment" required />

    <label for="location">Location:</label>
    <input type="text" id="location" placeholder="e.g. Cape Town" required />

    <label for="price">Price (ZAR/month):</label>
    <input type="number" id="price" placeholder="e.g. 2500" required />

    <label for="features">Features:</label>
    <textarea id="features" placeholder="e.g. 1 bedroom, 1 bathroom, WiFi included" required></textarea>

    <label for="images">Add Pictures (up to 6):</label>
    <input type="file" id="images" accept="image/*" multiple />
    <div id="preview-container"></div>

    <button type="submit">Submit Room</button>
  </form>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const form = document.getElementById("list-room-form");
const imagesInput = document.getElementById("images");
const previewContainer = document.getElementById("preview-container");
const pageContent = document.getElementById("page-content");
const homeBtn = document.getElementById("homeBtn");
const logoutBtn = document.getElementById("logoutBtn");

let currentUser = null;

// Show image previews
imagesInput.addEventListener("change", () => {
  previewContainer.innerHTML = "";
  const files = imagesInput.files;
  if(files.length > 6) { alert("You can upload up to 6 images."); imagesInput.value=""; return; }
  Array.from(files).forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    previewContainer.appendChild(img);
  });
});

// Auth check and role verification
onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href="login.html"; return; }
  currentUser = user;

  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    const role = userDoc.exists() ? userDoc.data().role : null;

    if(role !== "landlord") {
      alert("Access denied. Only landlords can list rooms.");
      await signOut(auth);
      window.location.href = "index.html";
      return;
    }

    // Show form for landlord
    pageContent.style.display = "block";
  } catch(err) {
    console.error(err);
    alert("Error checking user role.");
    await signOut(auth);
    window.location.href="index.html";
  }
});

// Buttons
homeBtn.addEventListener("click", () => window.location.href="index.html");
logoutBtn.addEventListener("click", async () => { 
  if(confirm("Logout?")) { 
    await signOut(auth); 
    window.location.href="index.html"; 
  } 
});

// Submit room
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if(!currentUser) return;

  const title = document.getElementById("title").value.trim();
  const location = document.getElementById("location").value.trim();
  const price = parseFloat(document.getElementById("price").value);
  const features = document.getElementById("features").value.trim();
  const files = imagesInput.files;
  const imageUrls = [];

  try {
    if(files.length > 0) {
      for(const file of files) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "unsigned_preset");
        const res = await fetch("https://api.cloudinary.com/v1_1/dixamcwb1/image/upload", { method:"POST", body:formData });
        const data = await res.json();
        if(data.secure_url) imageUrls.push(data.secure_url);
      }
    }

    const roomData = { title, location, price, features, images:imageUrls, landlordId:currentUser.uid, createdAt:serverTimestamp() };
    await addDoc(collection(db, "listings"), roomData);
    alert("‚úÖ Room listed successfully!");
    form.reset();
    previewContainer.innerHTML="";
  } catch(err) {
    console.error(err);
    alert("‚ùå Failed to list room. Please try again.");
  }
});
</script>
</body>
</html>
