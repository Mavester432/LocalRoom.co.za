<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Room â€“ LocalRoom</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    .form-container label {
      display: block;
      margin-top: 10px;
    }
    .form-container input,
    .form-container textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
    }
    .form-container button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #2a9d8f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-container button:hover {
      background: #21867a;
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>Edit Room Listing</h2>
  <form id="edit-room-form">
    <label for="title">Room Title:</label>
    <input type="text" id="title" required />

    <label for="location">Location:</label>
    <input type="text" id="location" required />

    <label for="price">Price (ZAR/month):</label>
    <input type="number" id="price" required />

    <label for="features">Features:</label>
    <textarea id="features" rows="4" required></textarea>

    <button type="submit">Save Changes</button>
  </form>
</div>

<script type="module">
  import { auth, db } from "./firebase-config.js";
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const form = document.getElementById("edit-room-form");
  const titleInput = document.getElementById("title");
  const locationInput = document.getElementById("location");
  const priceInput = document.getElementById("price");
  const featuresInput = document.getElementById("features");

  // Get room ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get("id");

  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("You must be logged in.");
      window.location.href = "login.html";
      return;
    }

    currentUser = user;

    const roomRef = doc(db, "listings", roomId);
    const roomSnap = await getDoc(roomRef);

    if (!roomSnap.exists()) {
      alert("Listing not found.");
      window.location.href = "dashboard.html";
      return;
    }

    const roomData = roomSnap.data();

    if (roomData.landlordId !== user.uid) {
      alert("You do not have permission to edit this listing.");
      window.location.href = "dashboard.html";
      return;
    }

    // Fill form with current data
    titleInput.value = roomData.title;
    locationInput.value = roomData.location;
    priceInput.value = roomData.price;
    featuresInput.value = roomData.features;
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      await updateDoc(doc(db, "listings", roomId), {
        title: titleInput.value,
        location: locationInput.value,
        price: parseFloat(priceInput.value),
        features: featuresInput.value
      });
      alert("Listing updated!");
      window.location.href = "dashboard.html";
    } catch (error) {
      console.error("Error updating listing:", error);
      alert("Failed to update listing.");
    }
  });
</script>

</body>
</html>
