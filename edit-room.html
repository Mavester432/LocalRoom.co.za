<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Room – LocalRoom</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
    }
    #preview-container img {
      max-width: 100px;
      max-height: 100px;
      object-fit: cover;
      margin: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      position: relative;
    }
    .img-wrapper {
      display: inline-block;
      position: relative;
    }
    .img-wrapper button {
      position: absolute;
      top: 2px;
      right: 2px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #2a9d8f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #21867a;
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>Edit Room Listing</h2>
  <form id="edit-room-form">
    <label for="title">Room Title:</label>
    <input type="text" id="title" required />

    <label for="location">Location:</label>
    <input type="text" id="location" required />

    <label for="price">Price (ZAR/month):</label>
    <input type="number" id="price" required />

    <label for="features">Features:</label>
    <textarea id="features" rows="4" required></textarea>

    <label for="new-images">Add New Images (optional):</label>
    <input type="file" id="new-images" accept="image/*" multiple />
    <div id="preview-container"></div>

    <button type="submit">Save Changes</button>
  </form>
</div>

<script type="module">
  import { auth, db } from "./firebase-config.js";
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const form = document.getElementById("edit-room-form");
  const titleInput = document.getElementById("title");
  const locationInput = document.getElementById("location");
  const priceInput = document.getElementById("price");
  const featuresInput = document.getElementById("features");
  const previewContainer = document.getElementById("preview-container");
  const newImagesInput = document.getElementById("new-images");

  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get("id");

  let currentUser = null;
  let existingImages = []; // URLs
  let removedImages = [];  // URLs to remove (not used for Cloudinary)

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("You must be logged in.");
      window.location.href = "login.html";
      return;
    }

    currentUser = user;

    const roomRef = doc(db, "listings", roomId);
    const roomSnap = await getDoc(roomRef);

    if (!roomSnap.exists()) {
      alert("Listing not found.");
      window.location.href = "dashboard.html";
      return;
    }

    const roomData = roomSnap.data();

    if (roomData.landlordId !== user.uid) {
      alert("Access denied.");
      window.location.href = "dashboard.html";
      return;
    }

    // Prefill form
    titleInput.value = roomData.title;
    locationInput.value = roomData.location;
    priceInput.value = roomData.price;
    featuresInput.value = roomData.features;
    existingImages = roomData.images || [];

    // Display existing images
    renderImages();
  });

  function renderImages() {
    previewContainer.innerHTML = "";
    existingImages.forEach((url, index) => {
      const wrapper = document.createElement("div");
      wrapper.className = "img-wrapper";

      const img = document.createElement("img");
      img.src = url;

      const btn = document.createElement("button");
      btn.innerHTML = "×";
      btn.onclick = () => {
        existingImages.splice(index, 1);
        renderImages();
      };

      wrapper.appendChild(img);
      wrapper.appendChild(btn);
      previewContainer.appendChild(wrapper);
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const files = newImagesInput.files;
    const totalImages = existingImages.length + files.length;

    if (totalImages > 6) {
      alert("You can have up to 6 images only.");
      return;
    }

    try {
      const uploadedUrls = [];

      for (let i = 0; i < files.length; i++) {
        const formData = new FormData();
        formData.append("file", files[i]);
        formData.append("upload_preset", "unsigned_preset");

        const res = await fetch("https://api.cloudinary.com/v1_1/dixamcwb1/image/upload", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (!data.secure_url) throw new Error("Upload failed");

        uploadedUrls.push(data.secure_url);
      }

      const updatedImages = [...existingImages, ...uploadedUrls];

      await updateDoc(doc(db, "listings", roomId), {
        title: titleInput.value,
        location: locationInput.value,
        price: parseFloat(priceInput.value),
        features: featuresInput.value,
        images: updatedImages
      });

      alert("Listing updated!");
      window.location.href = "dashboard.html";
    } catch (err) {
      console.error("Update failed:", err);
      alert("Something went wrong. Please try again.");
    }
  });
</script>

</body>
</html>
